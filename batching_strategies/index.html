
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A technical reference for LoRA, QLoRA, and other fine-tuning techniques.">
      
      
        <meta name="author" content="Saurabh Goyal">
      
      
      
        <link rel="prev" href="../decoding_strategies/speculative_decoding/">
      
      
        <link rel="next" href="../quantization/quantization_basics/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Batching Strategies - Fine-Tuning Methods Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-why-batching-matters" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Fine-Tuning Methods Documentation" class="md-header__button md-logo" aria-label="Fine-Tuning Methods Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fine-Tuning Methods Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Batching Strategies
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="lime"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/saurabhiit2007/LLM-Finetuning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Fine-Tuning Methods Documentation" class="md-nav__button md-logo" aria-label="Fine-Tuning Methods Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Fine-Tuning Methods Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/saurabhiit2007/LLM-Finetuning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fundamentals
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Fundamentals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/inference_basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inference Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/bottleneck_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bottleneck Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/latency_vs_throughput/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Latency vs Throughput
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/memory_compute_tradeoffs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Compute Tradeoffs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Attention Optimization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Attention Optimization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../attention_optimization/flash_attention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flash Attention
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../attention_optimization/flash_attention_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flash Attention 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../attention_optimization/kv_caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KV Caching
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../attention_optimization/paged_attention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Paged Attention
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Decoding Strategies
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Decoding Strategies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decoding_strategies/greedy_decoding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Greedy Decoding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decoding_strategies/beam_search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beam Search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decoding_strategies/sampling_methods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sampling Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decoding_strategies/speculative_decoding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Speculative Decoding
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Batching Strategies
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Batching Strategies
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-why-batching-matters" class="md-nav__link">
    <span class="md-ellipsis">
      1. Why Batching Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-static-batching" class="md-nav__link">
    <span class="md-ellipsis">
      2. Static Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Static Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use" class="md-nav__link">
    <span class="md-ellipsis">
      When to Use
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-dynamic-batching" class="md-nav__link">
    <span class="md-ellipsis">
      3. Dynamic Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Dynamic Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mechanism_1" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Key Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use_1" class="md-nav__link">
    <span class="md-ellipsis">
      When to Use
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-continuous-batching-iteration-level-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      4. Continuous Batching (Iteration-Level Scheduling)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Continuous Batching (Iteration-Level Scheduling)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-innovation" class="md-nav__link">
    <span class="md-ellipsis">
      Core Innovation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mechanism_2" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-impact" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Impact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trade-offs" class="md-nav__link">
    <span class="md-ellipsis">
      Trade-offs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-chunked-prefill" class="md-nav__link">
    <span class="md-ellipsis">
      5. Chunked Prefill
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Chunked Prefill">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mechanism_3" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-challenges" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Challenges
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-speculative-batching" class="md-nav__link">
    <span class="md-ellipsis">
      6. Speculative Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Speculative Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concept" class="md-nav__link">
    <span class="md-ellipsis">
      Concept
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mechanism_4" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-level-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Batch-Level Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenges" class="md-nav__link">
    <span class="md-ellipsis">
      Challenges
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-prefix-caching-in-batching" class="md-nav__link">
    <span class="md-ellipsis">
      7. Prefix Caching in Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Prefix Caching in Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem_1" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution_1" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-prefix-caching-apc" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic Prefix Caching (APC)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-level-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Batch-Level Benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-mixed-batch-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      8. Mixed Batch Scheduling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Mixed Batch Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenge" class="md-nav__link">
    <span class="md-ellipsis">
      Challenge
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#naive-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Naive Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimized-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Optimized Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splitfuse-deepspeed-fastgen" class="md-nav__link">
    <span class="md-ellipsis">
      SplitFuse (DeepSpeed-FastGen)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-batch-size-selection" class="md-nav__link">
    <span class="md-ellipsis">
      9. Batch Size Selection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Batch Size Selection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#factors" class="md-nav__link">
    <span class="md-ellipsis">
      Factors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heuristics" class="md-nav__link">
    <span class="md-ellipsis">
      Heuristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adaptive-batching" class="md-nav__link">
    <span class="md-ellipsis">
      Adaptive Batching
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-multi-query-batching-mqagqa-context" class="md-nav__link">
    <span class="md-ellipsis">
      10. Multi-Query Batching (MQA/GQA Context)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Multi-Query Batching (MQA/GQA Context)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relevance-to-batching" class="md-nav__link">
    <span class="md-ellipsis">
      Relevance to Batching
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impact" class="md-nav__link">
    <span class="md-ellipsis">
      Impact
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-interview-qa" class="md-nav__link">
    <span class="md-ellipsis">
      11. Interview Q&amp;A
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Quantization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Quantization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/quantization_basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quantization Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/int8_quantization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    INT8 Quantization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/int4_quantization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    INT4 Quantization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/gptq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GPTQ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/awq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWQ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/smoothquant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SmoothQuant
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/gguf_ggml/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GGUF GGML
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantization/quantization_tradeoffs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quantization Tradeoffs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Serving Frameworks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Serving Frameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../serving_frameworks/tensorrt_llm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TensorRT LLM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../serving_frameworks/text_generation_inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Text Generation Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../serving_frameworks/deepspeed_inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DeepSpeed Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../serving_frameworks/triton_inference_server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Triton Inference Server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../serving_frameworks/vllm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    vLLM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../serving_frameworks/framework_comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Framework Comparison
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-why-batching-matters" class="md-nav__link">
    <span class="md-ellipsis">
      1. Why Batching Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-static-batching" class="md-nav__link">
    <span class="md-ellipsis">
      2. Static Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Static Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use" class="md-nav__link">
    <span class="md-ellipsis">
      When to Use
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-dynamic-batching" class="md-nav__link">
    <span class="md-ellipsis">
      3. Dynamic Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Dynamic Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mechanism_1" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Key Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use_1" class="md-nav__link">
    <span class="md-ellipsis">
      When to Use
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-continuous-batching-iteration-level-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      4. Continuous Batching (Iteration-Level Scheduling)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Continuous Batching (Iteration-Level Scheduling)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-innovation" class="md-nav__link">
    <span class="md-ellipsis">
      Core Innovation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mechanism_2" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-impact" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Impact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trade-offs" class="md-nav__link">
    <span class="md-ellipsis">
      Trade-offs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-chunked-prefill" class="md-nav__link">
    <span class="md-ellipsis">
      5. Chunked Prefill
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Chunked Prefill">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mechanism_3" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-challenges" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Challenges
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-speculative-batching" class="md-nav__link">
    <span class="md-ellipsis">
      6. Speculative Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Speculative Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concept" class="md-nav__link">
    <span class="md-ellipsis">
      Concept
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mechanism_4" class="md-nav__link">
    <span class="md-ellipsis">
      Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-level-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Batch-Level Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenges" class="md-nav__link">
    <span class="md-ellipsis">
      Challenges
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-prefix-caching-in-batching" class="md-nav__link">
    <span class="md-ellipsis">
      7. Prefix Caching in Batching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Prefix Caching in Batching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem_1" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution_1" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-prefix-caching-apc" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic Prefix Caching (APC)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-level-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Batch-Level Benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-mixed-batch-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      8. Mixed Batch Scheduling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Mixed Batch Scheduling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenge" class="md-nav__link">
    <span class="md-ellipsis">
      Challenge
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#naive-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Naive Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimized-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Optimized Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splitfuse-deepspeed-fastgen" class="md-nav__link">
    <span class="md-ellipsis">
      SplitFuse (DeepSpeed-FastGen)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-batch-size-selection" class="md-nav__link">
    <span class="md-ellipsis">
      9. Batch Size Selection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Batch Size Selection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#factors" class="md-nav__link">
    <span class="md-ellipsis">
      Factors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heuristics" class="md-nav__link">
    <span class="md-ellipsis">
      Heuristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adaptive-batching" class="md-nav__link">
    <span class="md-ellipsis">
      Adaptive Batching
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-multi-query-batching-mqagqa-context" class="md-nav__link">
    <span class="md-ellipsis">
      10. Multi-Query Batching (MQA/GQA Context)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Multi-Query Batching (MQA/GQA Context)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relevance-to-batching" class="md-nav__link">
    <span class="md-ellipsis">
      Relevance to Batching
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impact" class="md-nav__link">
    <span class="md-ellipsis">
      Impact
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-interview-qa" class="md-nav__link">
    <span class="md-ellipsis">
      11. Interview Q&amp;A
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Batching Strategies</h1>

<h2 id="1-why-batching-matters">1. Why Batching Matters<a class="headerlink" href="#1-why-batching-matters" title="Permanent link">&para;</a></h2>
<p><strong>GPU Utilization Problem:</strong> <br>
- Single request uses &lt;10% of GPU compute capacity
- Memory bandwidth underutilized
- Expensive hardware sitting idle</p>
<p><strong>Batching Solution:</strong> <br>
- Process multiple requests simultaneously
- Amortize memory access costs
- Achieve 5-10x throughput improvement</p>
<p><strong>Key Constraint:</strong> GPU memory limits batch size (primarily KV cache)</p>
<hr />
<hr />
<h2 id="2-static-batching">2. Static Batching<a class="headerlink" href="#2-static-batching" title="Permanent link">&para;</a></h2>
<h3 id="mechanism">Mechanism<a class="headerlink" href="#mechanism" title="Permanent link">&para;</a></h3>
<ul>
<li>Accumulate N requests</li>
<li>Process entire batch together</li>
<li>Wait for ALL sequences to complete before accepting new requests</li>
</ul>
<hr />
<h3 id="characteristics">Characteristics<a class="headerlink" href="#characteristics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Batch: [Req1: 100 tokens, Req2: 20 tokens, Req3: 80 tokens]
All requests wait until Req1 (longest) completes
GPU idle during Req2, Req3 completion
</code></pre></div>
<p><strong>Throughput:</strong> Improved vs single request<br />
<strong>Latency:</strong> High variance (tail latency problem)<br />
<strong>GPU Utilization:</strong> Poor (bubbles after short sequences finish)</p>
<hr />
<h3 id="when-to-use">When to Use<a class="headerlink" href="#when-to-use" title="Permanent link">&para;</a></h3>
<ul>
<li>Offline batch processing</li>
<li>Known sequence lengths</li>
<li>Latency not critical</li>
</ul>
<hr />
<hr />
<h2 id="3-dynamic-batching">3. Dynamic Batching<a class="headerlink" href="#3-dynamic-batching" title="Permanent link">&para;</a></h2>
<h3 id="mechanism_1">Mechanism<a class="headerlink" href="#mechanism_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Accumulate requests up to max_batch_size OR max_delay</li>
<li>Whichever comes first triggers batch execution</li>
<li>Still waits for full batch completion before next batch</li>
</ul>
<hr />
<h3 id="key-parameters">Key Parameters<a class="headerlink" href="#key-parameters" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">max_batch_size</span> <span class="o">=</span> <span class="mi">32</span>      <span class="c1"># Maximum requests per batch</span>
<span class="n">max_delay_ms</span> <span class="o">=</span> <span class="mi">100</span>       <span class="c1"># Maximum wait time</span>
</code></pre></div>
<p><strong>Improvement over Static:</strong>
- Balances latency and throughput
- Reduces wait time for batch formation</p>
<p><strong>Still Limited:</strong>
- Batch-level scheduling (not iteration-level)
- GPU idle time after short sequences complete</p>
<hr />
<h3 id="when-to-use_1">When to Use<a class="headerlink" href="#when-to-use_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Services with moderate traffic</li>
<li>Simpler implementation than continuous batching</li>
<li>Good for non-LLM models (CV, audio)</li>
</ul>
<hr />
<hr />
<h2 id="4-continuous-batching-iteration-level-scheduling">4. Continuous Batching (Iteration-Level Scheduling)<a class="headerlink" href="#4-continuous-batching-iteration-level-scheduling" title="Permanent link">&para;</a></h2>
<h3 id="core-innovation">Core Innovation<a class="headerlink" href="#core-innovation" title="Permanent link">&para;</a></h3>
<p><strong>Iteration-Level Scheduling:</strong> Schedule at each decode step, not batch level</p>
<hr />
<h3 id="mechanism_2">Mechanism<a class="headerlink" href="#mechanism_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Initial Batch: [Req1, Req2, Req3, Req4]

Iteration 1: All generate token 1
Iteration 2: All generate token 2
Iteration 3: Req2 completes → Req5 joins → [Req1, Req3, Req4, Req5]
Iteration 4: Req5, Req3 complete → Req6, Req7 join → [Req1, Req4, Req6, Req7]
...
</code></pre></div>
<p><strong>Key Benefit:</strong> No GPU idle time, slots filled immediately</p>
<hr />
<h3 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h3>
<p><strong>Sequence Completion Detection:</strong> <br>
- Monitor for EOS tokens
- Max length reached
- User cancellation</p>
<p><strong>Slot Management:</strong> <br>
- Free KV cache blocks immediately
- Add waiting request to batch
- Update attention masks</p>
<p><strong>Memory Efficiency:</strong> <br>
- Works best with PagedAttention (vLLM)
- Non-contiguous memory allocation
- Independent per-sequence management</p>
<hr />
<h3 id="performance-impact">Performance Impact<a class="headerlink" href="#performance-impact" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Throughput:</strong> +20-30% vs dynamic batching</li>
<li><strong>Latency:</strong> Lower average, more consistent tail latency</li>
<li><strong>GPU Utilization:</strong> 80-95% (vs 50-70% for static)</li>
</ul>
<hr />
<h3 id="trade-offs">Trade-offs<a class="headerlink" href="#trade-offs" title="Permanent link">&para;</a></h3>
<ul>
<li>Complex implementation</li>
<li>Variable batch size per iteration</li>
<li>Requires sophisticated memory management</li>
</ul>
<hr />
<hr />
<h2 id="5-chunked-prefill">5. Chunked Prefill<a class="headerlink" href="#5-chunked-prefill" title="Permanent link">&para;</a></h2>
<h3 id="problem">Problem<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h3>
<p><strong>Long prompts block decode:</strong> <br>
<div class="highlight"><pre><span></span><code>Prompt: 10,000 tokens (prefill) → 50 iterations
Short prompts: waiting in queue
Decode operations: starved
</code></pre></div></p>
<hr />
<h3 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">&para;</a></h3>
<p>Break prefill into chunks, interleave with decode</p>
<hr />
<h3 id="mechanism_3">Mechanism<a class="headerlink" href="#mechanism_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Iteration 1: Chunk 1 of long prompt (512 tokens)
Iteration 2: Decode for ongoing requests
Iteration 3: Chunk 2 of long prompt (512 tokens)
Iteration 4: Decode for ongoing requests
...
</code></pre></div>
<p><strong>Parameters:</strong>
- <code>max_prefill_tokens</code>: Tokens to prefill per iteration
- Balances prefill throughput vs decode latency</p>
<hr />
<h3 id="benefits">Benefits<a class="headerlink" href="#benefits" title="Permanent link">&para;</a></h3>
<ul>
<li>Prevents large prompts from causing latency spikes</li>
<li>Better tail latency for decode operations</li>
<li>More predictable service times</li>
</ul>
<hr />
<h3 id="implementation-challenges">Implementation Challenges<a class="headerlink" href="#implementation-challenges" title="Permanent link">&para;</a></h3>
<ul>
<li>Partial KV cache management</li>
<li>Attention mask complexity</li>
<li>Scheduling overhead</li>
</ul>
<hr />
<hr />
<h2 id="6-speculative-batching">6. Speculative Batching<a class="headerlink" href="#6-speculative-batching" title="Permanent link">&para;</a></h2>
<h3 id="concept">Concept<a class="headerlink" href="#concept" title="Permanent link">&para;</a></h3>
<p>Combine speculative decoding with batching</p>
<hr />
<h3 id="mechanism_4">Mechanism<a class="headerlink" href="#mechanism_4" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Draft Phase:</strong> Small model predicts k tokens for all requests in batch</li>
<li><strong>Verification Phase:</strong> Large model verifies all k tokens in single pass</li>
<li><strong>Accept/Reject:</strong> Keep correct tokens, retry from first error</li>
</ol>
<hr />
<h3 id="batch-level-optimization">Batch-Level Optimization<a class="headerlink" href="#batch-level-optimization" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Without Speculation: 5 iterations for 5 tokens
With Speculation (k=5): 1 iteration (if all accepted)
Effective Speedup: 2-3x for batch
</code></pre></div>
<hr />
<h3 id="challenges">Challenges<a class="headerlink" href="#challenges" title="Permanent link">&para;</a></h3>
<ul>
<li>Variable acceptance rates across requests</li>
<li>Synchronization points</li>
<li>Draft model overhead</li>
</ul>
<hr />
<hr />
<h2 id="7-prefix-caching-in-batching">7. Prefix Caching in Batching<a class="headerlink" href="#7-prefix-caching-in-batching" title="Permanent link">&para;</a></h2>
<h3 id="problem_1">Problem<a class="headerlink" href="#problem_1" title="Permanent link">&para;</a></h3>
<p>Repeated prefixes waste computation</p>
<div class="highlight"><pre><span></span><code>User1: [System Prompt] + User Query 1
User2: [System Prompt] + User Query 2
User3: [System Prompt] + User Query 3
</code></pre></div>
<hr />
<h3 id="solution_1">Solution<a class="headerlink" href="#solution_1" title="Permanent link">&para;</a></h3>
<p><strong>Share KV cache blocks for common prefixes</strong></p>
<hr />
<h3 id="automatic-prefix-caching-apc">Automatic Prefix Caching (APC)<a class="headerlink" href="#automatic-prefix-caching-apc" title="Permanent link">&para;</a></h3>
<ul>
<li>Hash prompt prefixes</li>
<li>Reuse physical memory blocks</li>
<li>Multiple requests point to same KV cache</li>
</ul>
<hr />
<h3 id="batch-level-benefits">Batch-Level Benefits<a class="headerlink" href="#batch-level-benefits" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Without APC:
  3 requests × 1000-token system prompt = 3000 tokens in KV cache

With APC:
  3 requests share 1000-token KV cache = 1000 tokens total
  Effective batch size: 3x larger
</code></pre></div>
<hr />
<h3 id="use-cases">Use Cases<a class="headerlink" href="#use-cases" title="Permanent link">&para;</a></h3>
<ul>
<li>Multi-turn chat (common history)</li>
<li>RAG (shared context documents)</li>
<li>Agent frameworks (repeated tool descriptions)</li>
</ul>
<hr />
<hr />
<h2 id="8-mixed-batch-scheduling">8. Mixed Batch Scheduling<a class="headerlink" href="#8-mixed-batch-scheduling" title="Permanent link">&para;</a></h2>
<h3 id="challenge">Challenge<a class="headerlink" href="#challenge" title="Permanent link">&para;</a></h3>
<p>Different request types have different characteristics:</p>
<ul>
<li><strong>Prefill:</strong> Compute-bound, parallel</li>
<li><strong>Decode:</strong> Memory-bound, sequential</li>
</ul>
<hr />
<h3 id="naive-approach">Naive Approach<a class="headerlink" href="#naive-approach" title="Permanent link">&para;</a></h3>
<p>Separate batches for prefill and decode → Underutilization</p>
<hr />
<h3 id="optimized-approach">Optimized Approach<a class="headerlink" href="#optimized-approach" title="Permanent link">&para;</a></h3>
<p><strong>Mixed batches with resource allocation:</strong> <br></p>
<div class="highlight"><pre><span></span><code>GPU Resources:
  80% compute → Prefill operations
  20% memory bandwidth → Decode operations

Single iteration:
  Process prefill chunks (compute-heavy)
  Process decode steps (memory-heavy)
  Overlap when possible
</code></pre></div>
<hr />
<h3 id="splitfuse-deepspeed-fastgen">SplitFuse (DeepSpeed-FastGen)<a class="headerlink" href="#splitfuse-deepspeed-fastgen" title="Permanent link">&para;</a></h3>
<p>Dynamic algorithm that:
1. Monitors compute vs memory utilization
2. Adjusts prefill chunk size
3. Balances prefill/decode in each iteration</p>
<hr />
<hr />
<h2 id="9-batch-size-selection">9. Batch Size Selection<a class="headerlink" href="#9-batch-size-selection" title="Permanent link">&para;</a></h2>
<h3 id="factors">Factors<a class="headerlink" href="#factors" title="Permanent link">&para;</a></h3>
<p><strong>Memory Constraint:</strong> <br></p>
<div class="highlight"><pre><span></span><code>Available Memory = Model Weights + KV Cache + Activations
KV Cache = batch_size × seq_len × kv_memory_per_token
</code></pre></div>
<p><strong>Optimal Batch Size:</strong> <br>
- Too small → GPU underutilized
- Too large → OOM, increased latency</p>
<hr />
<h3 id="heuristics">Heuristics<a class="headerlink" href="#heuristics" title="Permanent link">&para;</a></h3>
<p><strong>For Decode:</strong> <br>
<div class="highlight"><pre><span></span><code>optimal_batch_size = GPU_memory / (model_size + max_seq_len × kv_per_token)
</code></pre></div></p>
<p><strong>For Prefill:</strong>
<div class="highlight"><pre><span></span><code>Limited by compute, not memory
Larger batches better (up to memory limit)
</code></pre></div></p>
<hr />
<h3 id="adaptive-batching">Adaptive Batching<a class="headerlink" href="#adaptive-batching" title="Permanent link">&para;</a></h3>
<p>Monitor queue depth and adjust:</p>
<ul>
<li>High queue → Increase batch size (if memory allows)</li>
<li>Low latency requirement → Decrease batch size</li>
<li>Balance throughput vs latency SLO</li>
</ul>
<hr />
<hr />
<h2 id="10-multi-query-batching-mqagqa-context">10. Multi-Query Batching (MQA/GQA Context)<a class="headerlink" href="#10-multi-query-batching-mqagqa-context" title="Permanent link">&para;</a></h2>
<h3 id="relevance-to-batching">Relevance to Batching<a class="headerlink" href="#relevance-to-batching" title="Permanent link">&para;</a></h3>
<p><strong>Multi-Query Attention (MQA):</strong>
- Fewer KV heads → Smaller KV cache
- Enables larger batch sizes</p>
<p><strong>Grouped-Query Attention (GQA):</strong>
- Middle ground between MHA and MQA
- Llama 3, Mistral use GQA</p>
<hr />
<h3 id="impact">Impact<a class="headerlink" href="#impact" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Llama 2 (MHA): 32 heads for K, 32 for V
Llama 3 (GQA): 8 KV heads, 32 Q heads

KV Cache Reduction: 4x
Batch Size Increase: ~4x at same memory
</code></pre></div>
<hr />
<hr />
<h2 id="11-interview-qa">11. Interview Q&amp;A<a class="headerlink" href="#11-interview-qa" title="Permanent link">&para;</a></h2>
<p><strong>Q: Why is continuous batching better than dynamic batching?</strong> <br>
A: Dynamic batching schedules at batch level, causing GPU idle time when short sequences complete. Continuous batching schedules at iteration level, immediately filling freed slots with new requests. This eliminates bubbles and improves throughput by 20-30%.</p>
<hr />
<p><strong>Q: What's the trade-off between batch size and latency?</strong> <br>
A: Larger batches increase throughput but also increase latency per request (more compute per iteration, longer queue wait times). Optimal batch size depends on SLO requirements and whether you're optimizing for throughput or latency.</p>
<hr />
<p><strong>Q: How does chunked prefill prevent latency spikes?</strong> <br>
A: Without chunking, a 10k token prefill blocks the GPU for many iterations, starving decode operations. Chunked prefill breaks it into smaller pieces (e.g., 512 tokens) and interleaves with decode, keeping decode latency predictable.</p>
<hr />
<p><strong>Q: Why does prefix caching improve effective batch size?</strong> <br>
A: Common prefixes (system prompts, RAG contexts) are stored once in memory and shared across requests. If 10 requests share a 1k token prefix, you save 9k tokens of KV cache, allowing 9 more requests to fit in the same memory.</p>
<hr />
<p><strong>Q: When would you use static batching instead of continuous batching?</strong> <br>
A: Offline batch processing with known sequence lengths, where latency doesn't matter and implementation simplicity is valued. For production online serving, continuous batching is almost always better.</p>
<hr />
<p><strong>Q: How does speculative decoding interact with batching?</strong> <br>
A: Draft model generates k tokens for entire batch, then target model verifies all in parallel. Benefit multiplies across batch. Challenge is handling variable acceptance rates—some sequences may accept all k tokens while others reject after first token.</p>
<hr />
<p><strong>Q: What determines the optimal prefill chunk size?</strong> <br>
A: Balance between prefill throughput and decode latency. Smaller chunks (256-512 tokens) minimize decode latency impact but reduce prefill efficiency. Larger chunks (1024-2048) maximize prefill throughput but can cause latency spikes. Typically tuned based on workload mix.</p>
<hr />
<p><strong>Q: Why does continuous batching require PagedAttention or similar?</strong> <br>
A: Variable batch sizes per iteration need dynamic memory allocation. Traditional contiguous allocation can't handle requests joining/leaving mid-batch efficiently. Paged memory allows independent per-sequence management without fragmentation.</p>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand", "navigation.top", "search.highlight", "search.share", "content.code.copy", "mathjax"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>