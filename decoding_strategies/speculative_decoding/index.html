
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A technical reference for LoRA, QLoRA, and other fine-tuning techniques.">
      
      
        <meta name="author" content="Saurabh Goyal">
      
      
      
        <link rel="prev" href="../sampling_methods/">
      
      
        <link rel="next" href="../../batching_strategies/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Speculative Decoding - Fine-Tuning Methods Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#speculative-decoding-interview-prep-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Fine-Tuning Methods Documentation" class="md-header__button md-logo" aria-label="Fine-Tuning Methods Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fine-Tuning Methods Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Speculative Decoding
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="lime"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/saurabhiit2007/LLM-Finetuning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Fine-Tuning Methods Documentation" class="md-nav__button md-logo" aria-label="Fine-Tuning Methods Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Fine-Tuning Methods Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/saurabhiit2007/LLM-Finetuning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fundamentals
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Fundamentals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fundamentals/inference_basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inference Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fundamentals/bottleneck_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bottleneck Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fundamentals/latency_vs_throughput/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Latency vs Throughput
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fundamentals/memory_compute_tradeoffs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Compute Tradeoffs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Attention Optimization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Attention Optimization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../attention_optimization/flash_attention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flash Attention
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../attention_optimization/flash_attention_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flash Attention 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../attention_optimization/kv_caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KV Caching
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../attention_optimization/paged_attention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Paged Attention
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Decoding Strategies
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Decoding Strategies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../greedy_decoding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Greedy Decoding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../beam_search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beam Search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sampling_methods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sampling Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Speculative Decoding
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Speculative Decoding
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-the-problem-with-standard-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      2. The Problem with Standard Decoding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. The Problem with Standard Decoding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sequential-bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      Sequential Bottleneck
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-how-speculative-decoding-works" class="md-nav__link">
    <span class="md-ellipsis">
      3. How Speculative Decoding Works
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. How Speculative Decoding Works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-idea" class="md-nav__link">
    <span class="md-ellipsis">
      Core Idea
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visual-example" class="md-nav__link">
    <span class="md-ellipsis">
      Visual Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-step-by-step-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      4. Step-by-Step Algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Step-by-Step Algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-draft-proposes-k-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Draft Proposes K Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-target-verifies-all-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Target Verifies All Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-accept-or-reject-each-token" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Accept or Reject Each Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-handle-rejection" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Handle Rejection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-why-its-faster" class="md-nav__link">
    <span class="md-ellipsis">
      5. Why It's Faster
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Why It&#39;s Faster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#speedup-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Speedup Analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-parallel-verification-works" class="md-nav__link">
    <span class="md-ellipsis">
      Why Parallel Verification Works
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-why-its-exact-not-approximate" class="md-nav__link">
    <span class="md-ellipsis">
      6. Why It's Exact (Not Approximate)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Why It&#39;s Exact (Not Approximate)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rejection-sampling-proof" class="md-nav__link">
    <span class="md-ellipsis">
      Rejection Sampling Proof
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-rejection-happens" class="md-nav__link">
    <span class="md-ellipsis">
      When Rejection Happens
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-practical-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      7. Practical Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Practical Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#draft-model-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Draft Model Selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#draft-length-k" class="md-nav__link">
    <span class="md-ellipsis">
      Draft Length K
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acceptance-rate" class="md-nav__link">
    <span class="md-ellipsis">
      Acceptance Rate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-interaction-with-kv-cache" class="md-nav__link">
    <span class="md-ellipsis">
      8. Interaction with KV Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Interaction with KV Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kv-cache-in-both-models" class="md-nav__link">
    <span class="md-ellipsis">
      KV Cache in Both Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-interview-questions" class="md-nav__link">
    <span class="md-ellipsis">
      9. Interview Questions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Interview Questions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#q1-what-is-speculative-decoding-and-why-is-it-faster" class="md-nav__link">
    <span class="md-ellipsis">
      Q1: What is speculative decoding and why is it faster?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q2-does-speculative-decoding-produce-exact-or-approximate-results" class="md-nav__link">
    <span class="md-ellipsis">
      Q2: Does speculative decoding produce exact or approximate results?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q3-why-cant-you-just-run-the-target-model-in-parallel-for-k-tokens-directly" class="md-nav__link">
    <span class="md-ellipsis">
      Q3: Why can't you just run the target model in parallel for K tokens directly?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q4-how-does-the-target-model-verify-k-tokens-in-one-pass" class="md-nav__link">
    <span class="md-ellipsis">
      Q4: How does the target model verify K tokens in one pass?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q5-what-happens-when-a-draft-token-is-rejected" class="md-nav__link">
    <span class="md-ellipsis">
      Q5: What happens when a draft token is rejected?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q6-what-determines-the-acceptance-rate" class="md-nav__link">
    <span class="md-ellipsis">
      Q6: What determines the acceptance rate?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q7-how-do-you-choose-the-draft-length-k" class="md-nav__link">
    <span class="md-ellipsis">
      Q7: How do you choose the draft length K?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q8-does-speculative-decoding-reduce-total-flops" class="md-nav__link">
    <span class="md-ellipsis">
      Q8: Does speculative decoding reduce total FLOPs?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q9-can-you-use-greedy-decoding-for-the-draft-model" class="md-nav__link">
    <span class="md-ellipsis">
      Q9: Can you use greedy decoding for the draft model?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q10-how-does-speculative-decoding-interact-with-kv-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Q10: How does speculative decoding interact with KV cache?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-variants-and-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      10. Variants and Extensions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Variants and Extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#medusa-multi-head-speculation" class="md-nav__link">
    <span class="md-ellipsis">
      Medusa / Multi-Head Speculation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lookahead-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      Lookahead Decoding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staged-speculative-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      Staged Speculative Decoding
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-key-takeaways-for-interviews" class="md-nav__link">
    <span class="md-ellipsis">
      11. Key Takeaways for Interviews
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-when-to-use-speculative-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      12. When to Use Speculative Decoding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. When to Use Speculative Decoding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#good-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Good Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#less-beneficial" class="md-nav__link">
    <span class="md-ellipsis">
      ❌ Less Beneficial
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../batching_strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batching Strategies
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Quantization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Quantization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/quantization_basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quantization Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/int8_quantization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    INT8 Quantization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/int4_quantization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    INT4 Quantization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/gptq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GPTQ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/awq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWQ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/smoothquant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SmoothQuant
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/gguf_ggml/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GGUF GGML
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantization/quantization_tradeoffs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quantization Tradeoffs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Serving Frameworks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Serving Frameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../serving_frameworks/tensorrt_llm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TensorRT LLM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../serving_frameworks/text_generation_inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Text Generation Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../serving_frameworks/deepspeed_inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DeepSpeed Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../serving_frameworks/triton_inference_server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Triton Inference Server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../serving_frameworks/vllm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    vLLM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../serving_frameworks/framework_comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Framework Comparison
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-the-problem-with-standard-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      2. The Problem with Standard Decoding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. The Problem with Standard Decoding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sequential-bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      Sequential Bottleneck
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-how-speculative-decoding-works" class="md-nav__link">
    <span class="md-ellipsis">
      3. How Speculative Decoding Works
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. How Speculative Decoding Works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-idea" class="md-nav__link">
    <span class="md-ellipsis">
      Core Idea
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visual-example" class="md-nav__link">
    <span class="md-ellipsis">
      Visual Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-step-by-step-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      4. Step-by-Step Algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Step-by-Step Algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-draft-proposes-k-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Draft Proposes K Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-target-verifies-all-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Target Verifies All Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-accept-or-reject-each-token" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Accept or Reject Each Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-handle-rejection" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Handle Rejection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-why-its-faster" class="md-nav__link">
    <span class="md-ellipsis">
      5. Why It's Faster
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Why It&#39;s Faster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#speedup-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Speedup Analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-parallel-verification-works" class="md-nav__link">
    <span class="md-ellipsis">
      Why Parallel Verification Works
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-why-its-exact-not-approximate" class="md-nav__link">
    <span class="md-ellipsis">
      6. Why It's Exact (Not Approximate)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Why It&#39;s Exact (Not Approximate)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rejection-sampling-proof" class="md-nav__link">
    <span class="md-ellipsis">
      Rejection Sampling Proof
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-rejection-happens" class="md-nav__link">
    <span class="md-ellipsis">
      When Rejection Happens
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-practical-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      7. Practical Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Practical Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#draft-model-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Draft Model Selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#draft-length-k" class="md-nav__link">
    <span class="md-ellipsis">
      Draft Length K
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acceptance-rate" class="md-nav__link">
    <span class="md-ellipsis">
      Acceptance Rate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-interaction-with-kv-cache" class="md-nav__link">
    <span class="md-ellipsis">
      8. Interaction with KV Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Interaction with KV Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kv-cache-in-both-models" class="md-nav__link">
    <span class="md-ellipsis">
      KV Cache in Both Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-interview-questions" class="md-nav__link">
    <span class="md-ellipsis">
      9. Interview Questions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Interview Questions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#q1-what-is-speculative-decoding-and-why-is-it-faster" class="md-nav__link">
    <span class="md-ellipsis">
      Q1: What is speculative decoding and why is it faster?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q2-does-speculative-decoding-produce-exact-or-approximate-results" class="md-nav__link">
    <span class="md-ellipsis">
      Q2: Does speculative decoding produce exact or approximate results?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q3-why-cant-you-just-run-the-target-model-in-parallel-for-k-tokens-directly" class="md-nav__link">
    <span class="md-ellipsis">
      Q3: Why can't you just run the target model in parallel for K tokens directly?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q4-how-does-the-target-model-verify-k-tokens-in-one-pass" class="md-nav__link">
    <span class="md-ellipsis">
      Q4: How does the target model verify K tokens in one pass?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q5-what-happens-when-a-draft-token-is-rejected" class="md-nav__link">
    <span class="md-ellipsis">
      Q5: What happens when a draft token is rejected?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q6-what-determines-the-acceptance-rate" class="md-nav__link">
    <span class="md-ellipsis">
      Q6: What determines the acceptance rate?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q7-how-do-you-choose-the-draft-length-k" class="md-nav__link">
    <span class="md-ellipsis">
      Q7: How do you choose the draft length K?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q8-does-speculative-decoding-reduce-total-flops" class="md-nav__link">
    <span class="md-ellipsis">
      Q8: Does speculative decoding reduce total FLOPs?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q9-can-you-use-greedy-decoding-for-the-draft-model" class="md-nav__link">
    <span class="md-ellipsis">
      Q9: Can you use greedy decoding for the draft model?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q10-how-does-speculative-decoding-interact-with-kv-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Q10: How does speculative decoding interact with KV cache?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-variants-and-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      10. Variants and Extensions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Variants and Extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#medusa-multi-head-speculation" class="md-nav__link">
    <span class="md-ellipsis">
      Medusa / Multi-Head Speculation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lookahead-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      Lookahead Decoding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staged-speculative-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      Staged Speculative Decoding
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-key-takeaways-for-interviews" class="md-nav__link">
    <span class="md-ellipsis">
      11. Key Takeaways for Interviews
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-when-to-use-speculative-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      12. When to Use Speculative Decoding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. When to Use Speculative Decoding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#good-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Good Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#less-beneficial" class="md-nav__link">
    <span class="md-ellipsis">
      ❌ Less Beneficial
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="speculative-decoding-interview-prep-guide">Speculative Decoding - Interview Prep Guide<a class="headerlink" href="#speculative-decoding-interview-prep-guide" title="Permanent link">&para;</a></h1>
<h2 id="1-overview">1. Overview<a class="headerlink" href="#1-overview" title="Permanent link">&para;</a></h2>
<p>Speculative decoding reduces <strong>inference latency</strong> in autoregressive LLMs by using a small <strong>draft model</strong> to propose multiple tokens that a large <strong>target model</strong> verifies in parallel. It produces <strong>exact same output distribution</strong> as standard decoding—not an approximation.</p>
<p><strong>Key insight:</strong> Instead of 1 token per expensive model call, verify K tokens in one call by having a cheap model guess ahead.</p>
<p><strong>Typical speedup:</strong> 2-3x latency reduction with no quality loss</p>
<hr />
<h2 id="2-the-problem-with-standard-decoding">2. The Problem with Standard Decoding<a class="headerlink" href="#2-the-problem-with-standard-decoding" title="Permanent link">&para;</a></h2>
<h3 id="sequential-bottleneck">Sequential Bottleneck<a class="headerlink" href="#sequential-bottleneck" title="Permanent link">&para;</a></h3>
<p>Autoregressive generation is inherently sequential:</p>
<div class="arithmatex">\[
P(x_1, x_2, \dots, x_T) = \prod_{t=1}^{T} P(x_t \mid x_{&lt;t})
\]</div>
<p><strong>Standard decoding loop:</strong>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">large_model</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>      <span class="c1"># Expensive!</span>
    <span class="n">next_token</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># Only use last position</span>
    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_token</span><span class="p">)</span>         <span class="c1"># Generate 1 token</span>
</code></pre></div></p>
<p><strong>Problems:</strong>
- Generate 1 token per forward pass
- Model sits mostly idle (memory-bound, not compute-bound)
- Latency grows linearly with output length
- KV cache helps computation but doesn't break sequential dependency</p>
<p><strong>Example:</strong> For 100 tokens, need 100 expensive forward passes of the large model.</p>
<hr />
<h2 id="3-how-speculative-decoding-works">3. How Speculative Decoding Works<a class="headerlink" href="#3-how-speculative-decoding-works" title="Permanent link">&para;</a></h2>
<h3 id="core-idea">Core Idea<a class="headerlink" href="#core-idea" title="Permanent link">&para;</a></h3>
<p><strong>Separate token proposal from verification:</strong></p>
<ol>
<li><strong>Draft model (small, fast):</strong> Proposes K tokens autoregressively</li>
<li><strong>Target model (large, expensive):</strong> Verifies all K tokens in <strong>one parallel forward pass</strong></li>
<li><strong>Accept/reject:</strong> Use rejection sampling to maintain correct distribution</li>
</ol>
<h3 id="visual-example">Visual Example<a class="headerlink" href="#visual-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Prompt: &quot;The capital of France is&quot;

Draft model proposes:  &quot;Paris , which is&quot;  (K=4 tokens)
                        ↓
Target model verifies all 4 tokens in one pass
                        ↓
Accept? [Paris: ✓] [,: ✓] [which: ✓] [is: ✗]
                        ↓
Output: &quot;The capital of France is Paris , which&quot;
Continue from &quot;which&quot; (3 tokens in 1 target pass instead of 3!)
</code></pre></div>
<hr />
<h2 id="4-step-by-step-algorithm">4. Step-by-Step Algorithm<a class="headerlink" href="#4-step-by-step-algorithm" title="Permanent link">&para;</a></h2>
<h3 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Draft model</strong> <span class="arithmatex">\(q\)</span>: Small, fast (e.g., 1B params)</li>
<li><strong>Target model</strong> <span class="arithmatex">\(p\)</span>: Large, accurate (e.g., 70B params)</li>
<li><strong>Draft length</strong> <span class="arithmatex">\(K\)</span>: Number of tokens to propose (typically 4-8)</li>
</ul>
<h3 id="step-1-draft-proposes-k-tokens">Step 1: Draft Proposes K Tokens<a class="headerlink" href="#step-1-draft-proposes-k-tokens" title="Permanent link">&para;</a></h3>
<p>Draft model generates K tokens autoregressively:</p>
<div class="arithmatex">\[
y_i \sim q(\cdot \mid x, y_{&lt;i}) \quad \text{for } i = 1, \dots, K
\]</div>
<p><strong>Important:</strong> Sample tokens (don't use greedy) and record <span class="arithmatex">\(q(y_i \mid x, y_{&lt;i})\)</span> for each.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Draft phase (cheap, K sequential calls to small model)</span>
<span class="n">draft_tokens</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">draft_probs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">draft_model</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">draft_tokens</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>  <span class="c1"># Sample, not greedy!</span>
    <span class="n">draft_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">draft_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="n">token</span><span class="p">])</span>  <span class="c1"># Record q(y_i)</span>
</code></pre></div>
<h3 id="step-2-target-verifies-all-tokens">Step 2: Target Verifies All Tokens<a class="headerlink" href="#step-2-target-verifies-all-tokens" title="Permanent link">&para;</a></h3>
<p>Target model runs <strong>once</strong> on the entire sequence:</p>
<div class="arithmatex">\[
\text{Input: } [x, y_1, y_2, \dots, y_K]
\]</div>
<p>This produces probabilities for all draft positions:</p>
<div class="arithmatex">\[
p(y_i \mid x, y_{&lt;i}) \quad \text{for } i = 1, \dots, K
\]</div>
<div class="highlight"><pre><span></span><code><span class="c1"># Verification phase (1 parallel call to large model)</span>
<span class="n">full_sequence</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">+</span> <span class="n">draft_tokens</span>
<span class="n">target_logits</span> <span class="o">=</span> <span class="n">target_model</span><span class="p">(</span><span class="n">full_sequence</span><span class="p">)</span>  <span class="c1"># Shape: [seq_len, vocab_size]</span>

<span class="c1"># Extract logits for draft positions only</span>
<span class="n">target_probs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Position before token i</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">target_logits</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
    <span class="n">target_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="n">draft_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>  <span class="c1"># p(y_i)</span>
</code></pre></div>
<p><strong>Key:</strong> Transformer naturally computes logits for all positions—speculative decoding just uses them.</p>
<h3 id="step-3-accept-or-reject-each-token">Step 3: Accept or Reject Each Token<a class="headerlink" href="#step-3-accept-or-reject-each-token" title="Permanent link">&para;</a></h3>
<p>Use rejection sampling to maintain correct distribution:</p>
<div class="arithmatex">\[
\alpha_i = \min\left(1, \frac{p(y_i \mid x, y_{&lt;i})}{q(y_i \mid x, y_{&lt;i})}\right)
\]</div>
<div class="highlight"><pre><span></span><code><span class="n">accepted</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="c1"># Acceptance probability</span>
    <span class="n">acceptance_prob</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">target_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">draft_probs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Random test</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">acceptance_prob</span><span class="p">:</span>
        <span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">draft_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># First rejection: stop here</span>
        <span class="k">break</span>
</code></pre></div>
<p><strong>Stop at first rejection</strong> (can't accept token 3 if token 2 was rejected).</p>
<h3 id="step-4-handle-rejection">Step 4: Handle Rejection<a class="headerlink" href="#step-4-handle-rejection" title="Permanent link">&para;</a></h3>
<p>If token <span class="arithmatex">\(j\)</span> is rejected:
- Discard <span class="arithmatex">\(y_j, y_{j+1}, \dots, y_K\)</span>
- Sample replacement from target model at position <span class="arithmatex">\(j\)</span>:</p>
<div class="arithmatex">\[
x_{\text{next}} \sim p(\cdot \mid x, y_{&lt;j})
\]</div>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">K</span><span class="p">:</span>  <span class="c1"># Some token was rejected</span>
    <span class="c1"># Sample next token from target model</span>
    <span class="n">rejection_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span>
    <span class="n">next_token</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">target_logits</span><span class="p">[</span><span class="n">rejection_pos</span><span class="p">])</span>
    <span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_token</span><span class="p">)</span>

<span class="c1"># Continue with accepted tokens</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">+</span> <span class="n">accepted</span>
</code></pre></div>
<p>If all K tokens accepted, continue with next draft batch.</p>
<hr />
<h2 id="5-why-its-faster">5. Why It's Faster<a class="headerlink" href="#5-why-its-faster" title="Permanent link">&para;</a></h2>
<h3 id="speedup-analysis">Speedup Analysis<a class="headerlink" href="#speedup-analysis" title="Permanent link">&para;</a></h3>
<p><strong>Standard decoding for N tokens:</strong>
- N forward passes of target model
- Cost: <span class="arithmatex">\(N \times C_{\text{target}}\)</span></p>
<p><strong>Speculative decoding:</strong>
- Draft proposes K tokens: <span class="arithmatex">\(K \times C_{\text{draft}}\)</span> (cheap)
- Target verifies in 1 pass: <span class="arithmatex">\(1 \times C_{\text{target}}\)</span>
- If acceptance rate = <span class="arithmatex">\(\alpha\)</span>, generate <span class="arithmatex">\(\alpha \times K\)</span> tokens per cycle</p>
<p><strong>Expected tokens per target call:</strong>
$$
E[\text{tokens}] = 1 + \sum_{i=1}^{K} \alpha^i \approx \frac{1 - \alpha^{K+1}}{1 - \alpha}
$$</p>
<p><strong>Example:</strong>
- <span class="arithmatex">\(K=4\)</span>, <span class="arithmatex">\(\alpha=0.7\)</span> → ~2.4 tokens per target call
- 2.4× speedup (vs 1 token per call in standard decoding)</p>
<h3 id="why-parallel-verification-works">Why Parallel Verification Works<a class="headerlink" href="#why-parallel-verification-works" title="Permanent link">&para;</a></h3>
<p>Transformers compute logits for <strong>all positions</strong> in one pass:
<div class="highlight"><pre><span></span><code>Input:  [&quot;The&quot;, &quot;cat&quot;, &quot;sat&quot;]
Output: [logits_0, logits_1, logits_2]
         ↓         ↓         ↓
      P(·|&quot;The&quot;) P(·|&quot;The cat&quot;) P(·|&quot;The cat sat&quot;)
</code></pre></div></p>
<p>Standard decoding only uses <code>logits_2</code> (last position).<br />
Speculative decoding uses <code>logits_0</code>, <code>logits_1</code>, <code>logits_2</code> to verify multiple tokens.</p>
<p><strong>This is not new capability</strong>—it's how Transformers always work during training.</p>
<hr />
<h2 id="6-why-its-exact-not-approximate">6. Why It's Exact (Not Approximate)<a class="headerlink" href="#6-why-its-exact-not-approximate" title="Permanent link">&para;</a></h2>
<h3 id="rejection-sampling-proof">Rejection Sampling Proof<a class="headerlink" href="#rejection-sampling-proof" title="Permanent link">&para;</a></h3>
<p>The acceptance rule:
$$
\alpha_i = \min\left(1, \frac{p(y_i)}{q(y_i)}\right)
$$</p>
<p>is standard <strong>rejection sampling</strong>:</p>
<ul>
<li>If <span class="arithmatex">\(p(y_i) \geq q(y_i)\)</span>: always accept (draft underestimated)</li>
<li>If <span class="arithmatex">\(p(y_i) &lt; q(y_i)\)</span>: accept with probability <span class="arithmatex">\(p/q\)</span> (draft overestimated)</li>
</ul>
<p><strong>Result:</strong> Accepted tokens have distribution <span class="arithmatex">\(p\)</span>, not <span class="arithmatex">\(q\)</span>.</p>
<p><strong>Mathematical guarantee:</strong> Output distribution is <strong>identical</strong> to sampling from target model directly.</p>
<h3 id="when-rejection-happens">When Rejection Happens<a class="headerlink" href="#when-rejection-happens" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Draft assigns:  q(&quot;Paris&quot;) = 0.8
Target assigns: p(&quot;Paris&quot;) = 0.9
→ Accept always (α = min(1, 0.9/0.8) = 1.0)

Draft assigns:  q(&quot;London&quot;) = 0.6
Target assigns: p(&quot;London&quot;) = 0.3
→ Accept 50% of time (α = 0.3/0.6 = 0.5)
</code></pre></div>
<p>Rejection corrects for draft model errors while maintaining exact target distribution.</p>
<hr />
<h2 id="7-practical-considerations">7. Practical Considerations<a class="headerlink" href="#7-practical-considerations" title="Permanent link">&para;</a></h2>
<h3 id="draft-model-selection">Draft Model Selection<a class="headerlink" href="#draft-model-selection" title="Permanent link">&para;</a></h3>
<p><strong>Options:</strong>
1. <strong>Smaller version of target</strong> (e.g., 1B vs 70B parameters)
2. <strong>Quantized target model</strong> (INT8 vs FP16)
3. <strong>Distilled model</strong> trained to match target
4. <strong>Early-exit from target</strong> (use intermediate layers)</p>
<p><strong>Requirements:</strong>
- Fast enough (≥10× faster than target)
- Similar enough to target (high acceptance rate)</p>
<h3 id="draft-length-k">Draft Length K<a class="headerlink" href="#draft-length-k" title="Permanent link">&para;</a></h3>
<p><strong>Trade-off:</strong>
- <strong>Small K (2-4):</strong> Lower overhead, guaranteed speedup
- <strong>Large K (8-16):</strong> Higher potential speedup, but more likely to reject</p>
<p><strong>Optimal K depends on:</strong>
- Acceptance rate (higher α → larger K beneficial)
- Draft/target speed ratio
- Memory constraints</p>
<p><strong>Typical:</strong> K=4-5 works well in practice</p>
<h3 id="acceptance-rate">Acceptance Rate<a class="headerlink" href="#acceptance-rate" title="Permanent link">&para;</a></h3>
<p><strong>Factors affecting α:</strong>
- Draft-target model similarity
- Task complexity (simple text → higher α)
- Prompt context (more context → better draft predictions)</p>
<p><strong>Typical rates:</strong>
- Good draft: α=0.7-0.9
- Poor draft: α=0.3-0.5</p>
<p><strong>Below α≈0.3:</strong> Speculative decoding may be slower than standard (overhead dominates).</p>
<hr />
<h2 id="8-interaction-with-kv-cache">8. Interaction with KV Cache<a class="headerlink" href="#8-interaction-with-kv-cache" title="Permanent link">&para;</a></h2>
<h3 id="kv-cache-in-both-models">KV Cache in Both Models<a class="headerlink" href="#kv-cache-in-both-models" title="Permanent link">&para;</a></h3>
<p><strong>Draft model:</strong>
- Maintains its own KV cache
- Generates K tokens autoregressively (K cache updates)</p>
<p><strong>Target model:</strong>
- Computes KV cache for entire draft window in one pass
- Accepted tokens' KV states are kept
- Rejected tokens' KV states are discarded</p>
<h3 id="memory-considerations">Memory Considerations<a class="headerlink" href="#memory-considerations" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Standard decoding: 1 model&#39;s KV cache
Speculative decoding: 2 models&#39; KV cache (draft + target)
</code></pre></div>
<p><strong>Memory cost:</strong> Minimal—draft model is small, so its cache is negligible.</p>
<hr />
<h2 id="9-interview-questions">9. Interview Questions<a class="headerlink" href="#9-interview-questions" title="Permanent link">&para;</a></h2>
<h3 id="q1-what-is-speculative-decoding-and-why-is-it-faster">Q1: What is speculative decoding and why is it faster?<a class="headerlink" href="#q1-what-is-speculative-decoding-and-why-is-it-faster" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> Speculative decoding uses a small draft model to propose K tokens cheaply, then a large target model verifies all K tokens in one parallel forward pass. Since Transformers compute logits for all positions naturally, we can check multiple draft tokens together. If most are accepted (high acceptance rate), we generate multiple tokens per expensive target model call instead of 1, reducing latency by 2-3× while maintaining exact output distribution.</p>
<hr />
<h3 id="q2-does-speculative-decoding-produce-exact-or-approximate-results">Q2: Does speculative decoding produce exact or approximate results?<a class="headerlink" href="#q2-does-speculative-decoding-produce-exact-or-approximate-results" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> <strong>Exact.</strong> It uses rejection sampling to correct for draft model errors. The acceptance probability α = min(1, p(y)/q(y)) ensures accepted tokens have the exact target distribution p, not the draft distribution q. The output is statistically identical to standard decoding with the target model—it's a latency optimization, not an approximation.</p>
<hr />
<h3 id="q3-why-cant-you-just-run-the-target-model-in-parallel-for-k-tokens-directly">Q3: Why can't you just run the target model in parallel for K tokens directly?<a class="headerlink" href="#q3-why-cant-you-just-run-the-target-model-in-parallel-for-k-tokens-directly" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> Autoregressive models have a causal dependency—token t depends on all tokens before it (t-1, t-2, ...). You <strong>cannot</strong> predict token t and token t+1 independently because t+1 needs t as input. Speculative decoding works around this by having the draft model make <strong>guesses</strong> (which may be wrong), then the target model verifies them all at once (which is valid because verification only requires a single forward pass).</p>
<hr />
<h3 id="q4-how-does-the-target-model-verify-k-tokens-in-one-pass">Q4: How does the target model verify K tokens in one pass?<a class="headerlink" href="#q4-how-does-the-target-model-verify-k-tokens-in-one-pass" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> Transformers naturally compute logits for <strong>all token positions</strong> in a forward pass, not just the last one. Given input [x, y₁, y₂, y₃], the model outputs logits for positions 0, 1, 2, 3. Standard decoding only uses the last position. Speculative decoding uses all positions to compute p(y₁|x), p(y₂|x,y₁), p(y₃|x,y₁,y₂) and compare them with the draft probabilities. This is how Transformers work during training—speculative decoding just reuses this during inference.</p>
<hr />
<h3 id="q5-what-happens-when-a-draft-token-is-rejected">Q5: What happens when a draft token is rejected?<a class="headerlink" href="#q5-what-happens-when-a-draft-token-is-rejected" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> Stop immediately at the first rejection:
1. Discard the rejected token and all subsequent draft tokens
2. Sample a replacement token from the target model at that position
3. Restart speculation from the new sequence</p>
<p>For example, if tokens 1,2 are accepted but token 3 is rejected, keep 1,2, sample a new token 3 from target, discard draft tokens 4,5,...,K. This maintains causality and correctness.</p>
<hr />
<h3 id="q6-what-determines-the-acceptance-rate">Q6: What determines the acceptance rate?<a class="headerlink" href="#q6-what-determines-the-acceptance-rate" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> How well the draft model matches the target model's distribution:
- <strong>High similarity</strong> (e.g., quantized version) → α=0.8-0.9 → 2-3× speedup
- <strong>Moderate similarity</strong> (e.g., smaller architecture) → α=0.5-0.7 → 1.5-2× speedup
- <strong>Low similarity</strong> → α&lt;0.3 → overhead dominates, possibly slower</p>
<p>Also affected by task (simple text has higher α) and context (more prompt context helps draft predict better).</p>
<hr />
<h3 id="q7-how-do-you-choose-the-draft-length-k">Q7: How do you choose the draft length K?<a class="headerlink" href="#q7-how-do-you-choose-the-draft-length-k" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> Trade-off between potential speedup and overhead:
- <strong>Higher acceptance rate α</strong> → can use larger K (more tokens likely accepted)
- <strong>Lower α</strong> → use smaller K (avoid wasting computation on rejections)
- <strong>Typical:</strong> K=4-5 works well across scenarios</p>
<p>Formula: Expected tokens per cycle ≈ (1-α^(K+1))/(1-α). Diminishing returns beyond K=5-8 for most acceptance rates.</p>
<hr />
<h3 id="q8-does-speculative-decoding-reduce-total-flops">Q8: Does speculative decoding reduce total FLOPs?<a class="headerlink" href="#q8-does-speculative-decoding-reduce-total-flops" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> No, it <strong>increases</strong> total FLOPs slightly (due to draft model overhead and potential rejections). The speedup comes from <strong>reducing latency</strong>—fewer sequential calls to the expensive target model. It's memory-bound optimization: better GPU utilization by verifying multiple tokens in parallel rather than one at a time. Wall-clock time decreases even though total compute increases.</p>
<hr />
<h3 id="q9-can-you-use-greedy-decoding-for-the-draft-model">Q9: Can you use greedy decoding for the draft model?<a class="headerlink" href="#q9-can-you-use-greedy-decoding-for-the-draft-model" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> No, you must <strong>sample</strong> from the draft model and record probabilities q(y_i). The rejection sampling formula requires q(y_i) to compute α = min(1, p(y_i)/q(y_i)). Greedy decoding doesn't provide a probability distribution over sampled tokens—it just picks argmax. Sampling is essential for the mathematical correctness guarantee.</p>
<hr />
<h3 id="q10-how-does-speculative-decoding-interact-with-kv-cache">Q10: How does speculative decoding interact with KV cache?<a class="headerlink" href="#q10-how-does-speculative-decoding-interact-with-kv-cache" title="Permanent link">&para;</a></h3>
<p><strong>Answer:</strong> Both models use KV cache:
- <strong>Draft model:</strong> Maintains its own cache, generates K tokens autoregressively
- <strong>Target model:</strong> Computes cache for entire draft window in one pass; keeps cache for accepted tokens, discards for rejected ones</p>
<p>Memory overhead is minimal since the draft model is small. KV cache improves efficiency (avoids recomputing attention) but doesn't change the algorithm—it's an orthogonal optimization.</p>
<hr />
<h2 id="10-variants-and-extensions">10. Variants and Extensions<a class="headerlink" href="#10-variants-and-extensions" title="Permanent link">&para;</a></h2>
<h3 id="medusa-multi-head-speculation">Medusa / Multi-Head Speculation<a class="headerlink" href="#medusa-multi-head-speculation" title="Permanent link">&para;</a></h3>
<ul>
<li>Add multiple prediction heads to draft model</li>
<li>Each head predicts different future positions in parallel</li>
<li>Tree-based verification (multiple candidate paths)</li>
</ul>
<h3 id="lookahead-decoding">Lookahead Decoding<a class="headerlink" href="#lookahead-decoding" title="Permanent link">&para;</a></h3>
<ul>
<li>Uses n-gram matching and Jacobi iterations</li>
<li>Doesn't require separate draft model</li>
<li>Lower speedup but no extra model needed</li>
</ul>
<h3 id="staged-speculative-decoding">Staged Speculative Decoding<a class="headerlink" href="#staged-speculative-decoding" title="Permanent link">&para;</a></h3>
<ul>
<li>Multiple draft models of increasing size</li>
<li>First draft proposes, second refines, target verifies</li>
<li>Can achieve higher acceptance rates</li>
</ul>
<hr />
<h2 id="11-key-takeaways-for-interviews">11. Key Takeaways for Interviews<a class="headerlink" href="#11-key-takeaways-for-interviews" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Main idea:</strong> Draft model proposes K tokens, target verifies all in one pass</li>
<li><strong>Speedup source:</strong> Multiple tokens per expensive model call (not reduced FLOPs)</li>
<li><strong>Exactness:</strong> Rejection sampling ensures identical distribution to target model</li>
<li><strong>Acceptance rate:</strong> Critical metric—need α&gt;0.5 for practical speedup</li>
<li><strong>Parallel verification:</strong> Uses existing Transformer capability (logits for all positions)</li>
<li><strong>Draft model:</strong> Must be 10×+ faster, doesn't need to be very accurate</li>
<li><strong>Typical gain:</strong> 2-3× latency reduction in production systems</li>
<li><strong>Memory:</strong> Minimal overhead (draft model is small)</li>
</ol>
<hr />
<h2 id="12-when-to-use-speculative-decoding">12. When to Use Speculative Decoding<a class="headerlink" href="#12-when-to-use-speculative-decoding" title="Permanent link">&para;</a></h2>
<h3 id="good-use-cases">✅ Good Use Cases<a class="headerlink" href="#good-use-cases" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Latency-critical serving</strong> (chatbots, real-time applications)</li>
<li><strong>Long-form generation</strong> (more tokens → more opportunities for speedup)</li>
<li><strong>Good draft model available</strong> (smaller version, quantized, distilled)</li>
<li><strong>Inference-bound workloads</strong> (not training)</li>
</ul>
<h3 id="less-beneficial">❌ Less Beneficial<a class="headerlink" href="#less-beneficial" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Batch inference</strong> (already parallelized across sequences)</li>
<li><strong>Very short outputs</strong> (overhead not amortized)</li>
<li><strong>No suitable draft model</strong> (acceptance rate too low)</li>
<li><strong>Memory-constrained systems</strong> (need to load 2 models)</li>
</ul>
<hr />
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://arxiv.org/abs/2211.17192">Fast Inference from Transformers via Speculative Decoding</a> - Original paper</li>
<li><a href="https://arxiv.org/abs/2302.01318">Accelerating Large Language Model Decoding with Speculative Sampling</a> - DeepMind's version</li>
<li><a href="https://arxiv.org/abs/2401.10774">Medusa: Simple LLM Inference Acceleration with Multiple Decoding Heads</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.top", "search.highlight", "search.share", "content.code.copy", "mathjax"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>